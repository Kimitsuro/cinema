{% extends 'base.html.twig' %}

{% block title %}–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä –°–∞–∫—É—Ä–∞{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('css/goer.css') }}?v={{ "now"|date("U") }}">
{% endblock %}

{% block body %}
    <!-- Main Content -->
    <main class="main-content">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <h2 class="sidebar-title">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#" class="nav-linck active" data-section="dashboard">
                            <span class="nav-icon">üìä</span>
                            <span>–ì–ª–∞–≤–Ω–∞—è</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-linck" data-section="tickets">
                            <span class="nav-icon">üé´</span>
                            <span>–ú–æ–∏ –±–∏–ª–µ—Ç—ã</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-linck" data-section="refunds">
                            <span class="nav-icon">üí∞</span>
                            <span>–í–æ–∑–≤—Ä–∞—Ç—ã</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-linck" data-section="profile">
                            <span class="nav-icon">üë§</span>
                            <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Dashboard Section -->
            <section class="content-section active" data-section="dashboard">
                <h1 class="section-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ goer.goerName ?? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}!</h1>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">{{ totalPurchases }}</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–∫—É–ø–æ–∫</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">{{ totalSpent|number_format(0, '.', ',') }} ‚ÇΩ</div>
                        <div class="stat-label">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">{{ activeTickets }}</div>
                        <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">{{ totalRefunds }}</div>
                        <div class="stat-label">–í–æ–∑–≤—Ä–∞—Ç–æ–≤</div>
                    </div>
                </div>

                <h3 style="color: var(--text-primary); margin-bottom: 1rem;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –±–∏–ª–µ—Ç—ã</h3>
                <div class="tickets-grid">
                    {% if latestTickets is empty %}
                        <p>–ë–∏–ª–µ—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
                    {% else %}
                        {% for ticket in latestTickets %}
                            <div class="ticket-card">
                                <div class="ticket-header">
                                    <div>
                                        <div class="ticket-movie">{{ ticket.session.movie.movieTitle }}</div>
                                        <div class="ticket-session">{{ ticket.session.sessionData|date('d.m.Y –≤ H:i') }}</div>
                                    </div>
                                    <span class="ticket-status {{ (ticket.session.sessionData > 'now'|date and ticket.ticketStatus != 'refunded' ? 'active' : 'expired') }}">
                                        {{ ticket.session.sessionData > 'now'|date and ticket.ticketStatus != 'refunded' ? '–ê–∫—Ç–∏–≤–Ω—ã–π' : '–ò—Å—Ç—ë–∫' }}
                                    </span>
                                </div>
                                <div class="ticket-details">
                                    <div class="ticket-detail">
                                        <div class="detail-label">–ó–∞–ª</div>
                                        <div class="detail-value">{{ ticket.session.hall.id }}</div>
                                    </div>
                                    <div class="ticket-detail">
                                        <div class="detail-label">–ú–µ—Å—Ç–æ</div>
                                        <div class="detail-value">–†—è–¥ {{ ticket.seat.seatRow }}, –ú–µ—Å—Ç–æ {{ ticket.seat.searNumber }}</div>
                                    </div>
                                    <div class="ticket-detail">
                                        <div class="detail-label">–¶–µ–Ω–∞</div>
                                        <div class="detail-value">
                                            {{ ticket.seat.seatType == 'economy' ? (ticket.session.sessionPrice * 0.8)|round(0, 'floor') : ticket.session.sessionPrice }} ‚ÇΩ
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </section>

            <!-- Tickets Section -->
            <section class="content-section" data-section="tickets">
                <h1 class="section-title">–ú–æ–∏ –±–∏–ª–µ—Ç—ã</h1>
                
                <div class="tickets-filter">
                    <button class="filter-btn active" data-filter="all">–í—Å–µ –±–∏–ª–µ—Ç—ã</button>
                    <button class="filter-btn" data-filter="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
                    <button class="filter-btn" data-filter="refunded">–í–æ–∑–≤—Ä–∞—â—ë–Ω–Ω—ã–µ</button>
                </div>

                <div class="tickets-grid">
                    {% if allTickets is empty %}
                        <p>–ë–∏–ª–µ—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
                    {% else %}
                        {% for ticket in allTickets %}
                            {% set status = ticket.ticketStatus == 'refunded' ? 'refunded' : (ticket.session.sessionData > 'now'|date ? 'active' : 'expired') %}
                            {% set statusText = ticket.ticketStatus == 'refunded' ? '–í–æ–∑–≤—Ä–∞—â—ë–Ω' : (ticket.session.sessionData > 'now'|date ? '–ê–∫—Ç–∏–≤–Ω—ã–π' : '–ò—Å—Ç—ë–∫') %}
                            <div class="ticket-card" data-status="{{ status }}">
                                <div class="ticket-header">
                                    <div>
                                        <div class="ticket-movie">{{ ticket.session.movie.movieTitle }}</div>
                                        <div class="ticket-session">{{ ticket.session.sessionData|date('d.m.Y –≤ H:i') }}</div>
                                    </div>
                                    <span class="ticket-status {{ status }}">{{ statusText }}</span>
                                </div>
                                <div class="ticket-details">
                                    <div class="ticket-detail">
                                        <div class="detail-label">–ó–∞–ª</div>
                                        <div class="detail-value">{{ ticket.session.hall.id }}</div>
                                    </div>
                                    <div class="ticket-detail">
                                        <div class="detail-label">–ú–µ—Å—Ç–æ</div>
                                        <div class="detail-value">–†—è–¥ {{ ticket.seat.seatRow }}, –ú–µ—Å—Ç–æ {{ ticket.seat.searNumber }}</div>
                                    </div>
                                    <div class="ticket-detail">
                                        <div class="detail-label">–¶–µ–Ω–∞</div>
                                        <div class="detail-value">
                                            {{ ticket.seat.seatType == 'economy' ? (ticket.session.sessionPrice * 0.8)|round(0, 'floor') : ticket.session.sessionPrice }} ‚ÇΩ
                                        </div>
                                    </div>
                                    <div class="ticket-detail">
                                        <div class="detail-label">–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏</div>
                                        <div class="detail-value">{{ ticket.purchase.purchaseDate|date('d.m.Y') }}</div>
                                    </div>
                                </div>
                                {% if status == 'active' %}
                                <div class="ticket-actions">
                                    <button class="btn btn-danger btn-small" onclick="openRefundModal({{ ticket.id }})">–í–µ—Ä–Ω—É—Ç—å –±–∏–ª–µ—Ç</button>
                                </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </section>

            <!-- Refunds Section -->
            <section class="content-section" data-section="refunds">
                <h1 class="section-title">–í–æ–∑–≤—Ä–∞—Ç—ã –±–∏–ª–µ—Ç–æ–≤</h1>
                
                {% if refunds is empty %}
                    <p>–ó–∞—è–≤–æ–∫ –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç –ø–æ–∫–∞ –Ω–µ—Ç.</p>
                {% else %}
                    {% for refund in refunds %}
                        {% set refundStatus = refund.refundStatus %}
                        {% set refundStatusText = {'pending': '–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏', 'approved': '–û–¥–æ–±—Ä–µ–Ω', 'rejected': '–û—Ç–∫–ª–æ–Ω—ë–Ω'}[refund.refundStatus] %}
                        <div class="refund-card">
                            <div class="refund-header">
                                <div class="refund-id">–í–æ–∑–≤—Ä–∞—Ç #{{ refund.id }}</div>
                                <span class="refund-status {{ refundStatus }}">{{ refundStatusText }}</span>
                            </div>
                            <div class="refund-refundReason">"{{ refund.refundReason }}"</div>
                            <div class="ticket-details">
                                <div class="ticket-detail">
                                    <div class="detail-label">–§–∏–ª—å–º</div>
                                    <div class="detail-value">{{ refund.ticket.session.movie.movieTitle }}</div>
                                </div>
                                <div class="ticket-detail">
                                    <div class="detail-label">–î–∞—Ç–∞ —Å–µ–∞–Ω—Å–∞</div>
                                    <div class="detail-value">{{ refund.ticket.session.sessionData|date('d.m.Y –≤ H:i') }}</div>
                                </div>
                                <div class="ticket-detail">
                                    <div class="detail-label">–°—É–º–º–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞</div>
                                    <div class="detail-value">{{ (refund.ticket.seat.seatType == 'economy' ? (refund.ticket.session.sessionPrice * 0.8) : refund.ticket.session.sessionPrice) }} ‚ÇΩ</div>
                                </div>
                                <div class="ticket-detail">
                                    <div class="detail-label">–î–∞—Ç–∞ –ø–æ–¥–∞—á–∏</div>
                                    <div class="detail-value">{{ refund.refundDate|date('d.m.Y') }}</div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
            </section>

            <!-- Profile Section -->
            <section class="content-section" data-section="profile">
                <h1 class="section-title">–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h1>
                
                <form class="profile-form">
                    <div class="form-group">
                        <label class="form-label" for="name">–ò–º—è</label>
                        <input type="text" id="name" class="form-input" value="{{ goer.goerName ?? '' }}">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="email">Email</label>
                        <input type="email" id="email" class="form-input" value="{{ goer.goerEmail ?? '' }}" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="tel" id="phone" class="form-input" value="{{ goer.goerPhone ?? '' }}">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="password">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                        <input type="password" id="password" class="form-input" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ –º–µ–Ω—è—Ç—å">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="password_confirm">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                        <input type="password" id="password_confirm" class="form-input" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
                    </div>
                    
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </form>
            </section>
        </div>
    </main>

    <!-- Refund Modal -->
    <div class="modal" id="refundModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">–í–æ–∑–≤—Ä–∞—Ç –±–∏–ª–µ—Ç–∞</h3>
                <button class="modal-close" onclick="closeRefundModal()">√ó</button>
            </div>
            
            <form id="refundForm">
                <div class="form-group">
                    <label class="form-label" for="refund_reason">–ü—Ä–∏—á–∏–Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞</label>
                    <textarea id="refund_reason" class="form-input" rows="4" placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –≤–æ–∑–≤—Ä–∞—Ç–∞ –±–∏–ª–µ—Ç–∞" required></textarea>
                </div>
                
                <div style="margin-bottom: 1rem; padding: 1rem; background: var(--primary-dark); border-radius: 8px;">
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –í–æ–∑–≤—Ä–∞—Ç –±–∏–ª–µ—Ç–∞ –≤–æ–∑–º–æ–∂–µ–Ω –Ω–µ –ø–æ–∑–¥–Ω–µ–µ —á–µ–º –∑–∞ 2 —á–∞—Å–∞ –¥–æ –Ω–∞—á–∞–ª–∞ —Å–µ–∞–Ω—Å–∞.
                    </p>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeRefundModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-danger">–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script>
        // Navigation
        document.querySelectorAll('.nav-linck').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active class from all links and sections
                document.querySelectorAll('.nav-linck').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                
                // Add active class to clicked link
                this.classList.add('active');
                
                // Show corresponding section
                const sectionName = this.dataset.section;
                document.querySelector(`.content-section[data-section="${sectionName}"]`).classList.add('active');
            });
        });

        // Ticket filters
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove active class from all filter buttons
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                const filter = this.dataset.filter;
                const tickets = document.querySelectorAll('.ticket-card[data-status]');
                
                tickets.forEach(ticket => {
                    if (filter === 'all' || ticket.dataset.status === filter) {
                        ticket.style.display = 'block';
                    } else {
                        ticket.style.display = 'none';
                    }
                });
            });
        });

        // Refund modal
        function openRefundModal(ticketId) {
            document.getElementById('refundModal').classList.add('active');
            document.getElementById('refundForm').dataset.ticketId = ticketId;
        }

        function closeRefundModal() {
            document.getElementById('refundModal').classList.remove('active');
            document.getElementById('refundForm').dataset.ticketId = '';
        }

        // Close modal on outside click
        document.getElementById('refundModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeRefundModal();
            }
        });

        // Refund form submission
        document.getElementById('refundForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const ticketId = this.dataset.ticketId;
            const reason = document.getElementById('refund_reason').value;

            if (!ticketId || !reason.trim()) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.');
                return;
            }

            try {
                const response = await fetch('{{ path('goer_refund') }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        ticketId: ticketId,
                        reason: reason
                    })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∞—á–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç');
                }

                alert('–ó–∞—è–≤–∫–∞ –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç –±–∏–ª–µ—Ç–∞ –ø–æ–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
                closeRefundModal();
                document.getElementById('refund_reason').value = '';
                window.location.reload(); // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
            } catch (error) {
                console.error('Refund error:', error.message);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∞—á–µ –∑–∞—è–≤–∫–∏: ' + error.message);
            }
        });

        // Profile form submission
        document.querySelector('.profile-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const password = document.getElementById('password').value;
            const passwordConfirm = document.getElementById('password_confirm').value;

            if (password && password !== passwordConfirm) {
                alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!');
                return;
            }

            try {
                const response = await fetch('{{ path('goer_profile_update') }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        name: name,
                        phone: phone,
                        password: password
                    })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö');
                }

                alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            } catch (error) {
                console.error('Profile update error:', error.message);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            }
        });
    </script>
{% endblock %}